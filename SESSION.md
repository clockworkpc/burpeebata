# BurpeeBata Authentication Implementation Session

## Date
2025-11-25

## Issue Addressed
**Issue #5: User Sign-up, Login, and Profile**

Required lightweight backend for user authentication across:
- Android app (Google Play)
- iOS app (App Store)
- Web app (burpeebata.com)

Google Play requires reviewer access without creating accounts or using free trials.

## Solution Selected

**Firebase (Free Tier)**
- Authentication: Email/Password + Anonymous
- Database: Cloud Firestore
- Cost: $0-5/month for small user base
- Platforms: Android, iOS, Web support

## Implementation Summary

### 1. Models Created

**`lib/models/user_profile.dart`**
- User profile with optional fields:
  - `name` (String?)
  - `age` (int?)
  - `sex` (Sex enum - Male/Female, defaults to Male)
  - `heightCm` (double?)
  - `weightKg` (double?)
- All fields optional except `userId`
- Includes JSON serialization for Firestore

### 2. Services Implemented

**`lib/services/auth_service.dart`**
- Firebase Authentication wrapper
- Methods:
  - `signUp(email, password)` - Email/password registration
  - `signIn(email, password)` - Email/password login
  - `signInAnonymously()` - Guest access
  - `signOut()` - Sign out
  - `sendPasswordResetEmail(email)` - Password reset
  - `convertAnonymousAccount(email, password)` - Convert guest to permanent
  - `deleteAccount()` - Account deletion
- Custom exception handling with user-friendly messages

**`lib/services/user_service.dart`**
- Firestore database wrapper for user profiles
- Methods:
  - `getUserProfile(userId)` - Fetch profile
  - `userProfileStream(userId)` - Real-time profile updates
  - `createUserProfile(profile)` - Create new profile
  - `updateUserProfile(profile)` - Update existing profile
  - `deleteUserProfile(userId)` - Delete profile
  - `saveUserProfile(profile)` - Create or update

### 3. State Management

**`lib/providers/auth_provider.dart`**
- Provider for authentication state
- Manages:
  - Current user (Firebase User)
  - User profile (UserProfile)
  - Loading state
  - Error messages
- Auto-creates empty profile for new users
- Exposes methods for all auth operations
- Listens to auth state changes and syncs profile

### 4. UI Screens

**`lib/screens/login_screen.dart`**
- Email/password login form
- "Continue as Guest" button (anonymous auth)
- Link to signup screen
- Password visibility toggle
- Form validation
- Error display via SnackBar

**`lib/screens/signup_screen.dart`**
- Email/password registration form
- Password confirmation with validation
- Password visibility toggles
- Form validation (email format, password length, matching passwords)
- Success/error messaging
- Link back to login

**`lib/screens/profile_screen.dart`**
- Optional profile editing form
- Fields: name, age, sex, height (cm), weight (kg)
- All fields optional with validation
- Number input formatters for age/height/weight
- Sex dropdown (Male/Female)
- Save button with loading state
- Clear user messaging about optional nature

**`lib/screens/auth_wrapper.dart`**
- Routes users based on authentication state
- Shows loading spinner during auth check
- Redirects to HomeScreen if authenticated
- Redirects to LoginScreen if not authenticated

**Updated `lib/screens/home_screen.dart`**
- Added account menu (PopupMenuButton) with profile icon
- Menu options:
  - Profile (for authenticated non-anonymous users)
  - Sign Out / Sign In (changes based on auth state)
- Integration with AuthProvider for state management

### 5. App Integration

**Updated `lib/main.dart`**
- Added Firebase initialization in `main()`:
  ```dart
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  ```
- Wrapped app in `ChangeNotifierProvider<AuthProvider>`
- Changed home to `AuthWrapper` instead of `HomeScreen`

**Updated `pubspec.yaml`**
- Added dependencies:
  - `firebase_core: ^3.3.0`
  - `firebase_auth: ^5.1.4`
  - `cloud_firestore: ^5.2.1`
  - `provider: ^6.1.2`

### 6. Firebase Configuration

**Generated `lib/firebase_options.dart`**
- Auto-generated by `flutterfire configure`
- Contains Firebase config for all platforms:
  - Android: `com.burpeebata.app`
  - iOS: `com.burpeebata.app`
  - macOS: `com.burpeebata.app`
  - Web: `burpeebata (web)`
  - Windows: `burpeebata (windows)`
- Firebase Project: `burpeebata`

### 7. Documentation

**`FIREBASE_SETUP.md`**
- Complete Firebase configuration guide
- Prerequisites (Firebase CLI, FlutterFire CLI)
- Step-by-step setup:
  1. Create Firebase project
  2. Enable Authentication (Email/Password, Anonymous)
  3. Create Firestore database
  4. Configure Firebase for Flutter (`flutterfire configure`)
  5. Platform-specific configuration
  6. Create demo account
  7. Install dependencies
  8. Run the app
- Firestore security rules
- Troubleshooting guide
- Cost estimates
- Security best practices

**`APP_STORE_REVIEWER_ACCESS.md`**
- Instructions for app store submissions
- Two reviewer access methods:
  1. **Guest Access (Recommended)**: Tap "Continue as Guest"
  2. **Demo Account**: `reviewer@burpeebata.com` / `Reviewer2025!`
- Feature overview for reviewers
- Technical details (Firebase, platforms, security)
- Quick start guide

**Updated `CLAUDE.md`**
- Added authentication architecture section
- Updated directory structure with new screens/services/providers
- Updated dependency list with Firebase packages
- Added authentication methods overview
- Added user profile structure
- References to setup docs
- Quick access info for reviewers

## Architecture Decisions

### Why Firebase?
1. **Cost-effective**: Free tier sufficient for small apps
2. **Multi-platform**: Single backend for Android, iOS, Web
3. **Official Flutter support**: Well-maintained Firebase packages
4. **No server management**: Fully managed service
5. **Built-in features**: Auth, database, real-time sync

### Why Anonymous Auth?
- Perfect for app store reviewers (no account creation needed)
- Allows instant app access
- Can be converted to permanent account later
- Complies with Google Play requirements

### Why Optional Profile?
- Respects user privacy
- Reduces friction in onboarding
- App works without any personal data
- Users can gradually complete profile

### Why Provider for State Management?
- Lightweight and simple
- Official Flutter recommendation
- Good for auth state management
- Easy integration with existing app

## Firestore Security Rules

Default rules (deny all):
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

**Required rules for BurpeeBata:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

This ensures:
- Only authenticated users can access profiles
- Users can only access their own data
- Anonymous users get unique UIDs and can access their profile

## Next Steps to Complete Implementation

### 1. Firebase Console Configuration

**Enable Authentication:**
1. Go to [Firebase Console](https://console.firebase.google.com/project/burpeebata)
2. Navigate to **Authentication** → **Sign-in method**
3. Enable **Email/Password** provider
4. Enable **Anonymous** provider

**Create Firestore Database:**
1. Go to **Firestore Database**
2. Click **Create database**
3. Choose **production mode**
4. Select location (e.g., `us-central1`)
5. Update **Rules** tab with the security rules above

**Create Demo Account (Optional):**
1. Go to **Authentication** → **Users**
2. Click **Add user**
3. Email: `reviewer@burpeebata.com`
4. Password: `Reviewer2025!`

### 2. Install Dependencies

```bash
docker compose exec flutter flutter pub get
```

### 3. Test Authentication Flow

1. Start the app: `make up`
2. Test guest login: Click "Continue as Guest"
3. Test signup: Create a new account
4. Test login: Sign in with created account
5. Test profile: Edit profile information
6. Test sign out: Use account menu

### 4. Platform Testing

- **Android**: Test on emulator/device
- **iOS**: Test on simulator/device (if on macOS)
- **Web**: Test in browser at `localhost:8080`

### 5. App Store Submission

When submitting to Google Play and App Store:
- Include contents of `APP_STORE_REVIEWER_ACCESS.md` in submission notes
- Highlight the "Continue as Guest" feature
- Provide demo account credentials as backup

## Files Created

```
lib/
├── firebase_options.dart (generated)
├── models/
│   └── user_profile.dart
├── services/
│   ├── auth_service.dart
│   └── user_service.dart
├── providers/
│   └── auth_provider.dart
└── screens/
    ├── auth_wrapper.dart
    ├── login_screen.dart
    ├── signup_screen.dart
    └── profile_screen.dart

Documentation:
├── FIREBASE_SETUP.md
├── APP_STORE_REVIEWER_ACCESS.md
├── CLAUDE.md (updated)
└── SESSION.md (this file)

Configuration:
├── pubspec.yaml (updated)
└── lib/main.dart (updated)
```

## Key Features Implemented

✅ Email/password authentication
✅ Anonymous/guest authentication
✅ Optional user profile (all fields optional)
✅ Profile CRUD operations
✅ Real-time auth state management
✅ Cross-platform support (Android, iOS, Web)
✅ Account conversion (guest → permanent)
✅ Password reset functionality
✅ Account deletion
✅ Secure Firestore rules
✅ Reviewer access methods
✅ Comprehensive documentation

## Cost Analysis

**Firebase Free Tier:**
- 50,000 MAU (Monthly Active Users)
- 50,000 document reads/day
- 20,000 document writes/day
- 1 GB storage

**Estimated costs:**
- < 1,000 users: **$0/month**
- 1,000-10,000 users: **$0-5/month**
- 10,000+ users: **$5-25/month** (depends on usage)

## Security Considerations

✅ Firestore security rules enforce user-specific access
✅ Firebase Auth handles password encryption
✅ API keys in `firebase_options.dart` are safe to commit (public keys)
✅ All data encrypted in transit (HTTPS)
✅ All data encrypted at rest (Firebase default)
✅ No sensitive data in profile (all optional)

## Testing Checklist

- [ ] Install dependencies: `flutter pub get`
- [ ] Enable Email/Password auth in Firebase Console
- [ ] Enable Anonymous auth in Firebase Console
- [ ] Create Firestore database
- [ ] Update Firestore security rules
- [ ] Create demo account (optional)
- [ ] Test guest login flow
- [ ] Test signup flow
- [ ] Test login flow
- [ ] Test profile editing
- [ ] Test sign out
- [ ] Test password reset
- [ ] Test account deletion
- [ ] Test on Android
- [ ] Test on iOS
- [ ] Test on Web

## Additional Notes

- The `com.burpeebata.app` package name should be changed to a production package name before release (e.g., `com.burpeebata.app`)
- Consider adding email verification for production
- Monitor Firebase usage in console to avoid unexpected costs
- Set up budget alerts in Firebase Console
- Consider implementing App Check for production to prevent abuse
- Add analytics/crashlytics if needed for production monitoring

---

## Post-Implementation Updates

### Package Name Change (2025-11-25)

Updated package name from `com.example.burpeebata` to `com.burpeebata.app`:

**Files Updated:**
1. `android/app/build.gradle` - Changed `applicationId` to `com.burpeebata.app`
2. `android/app/src/main/AndroidManifest.xml` - Changed `package` to `com.burpeebata.app`
3. `android/app/src/main/kotlin/com/example/burpeebata/MainActivity.kt` - Updated package declaration to `com.burpeebata.app`

**Completed:**
- ✅ Moved MainActivity.kt from `android/app/src/main/kotlin/com/example/burpeebata/` to `android/app/src/main/kotlin/com/burpeebata/app/`
- ✅ Old package structure cleaned up

**Firebase Configuration:**
- Re-ran `flutterfire configure` to update Firebase apps with new package name
- Firebase project now has apps registered with `com.burpeebata.app` for Android
- iOS bundle ID may still show `com.example.burpeebata` in `firebase_options.dart:67` - update if targeting iOS production

### Firebase Console Setup Completed

**Authentication Providers Enabled:**
- ✅ Email/Password authentication enabled
- ✅ Anonymous authentication enabled

**Firestore Database:**
- ✅ Created in production mode
- ✅ Security rules updated to allow authenticated users to access their own profiles:
  ```javascript
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  ```

**Dependencies:**
- ✅ Installed Flutter dependencies with `flutter pub get`

### Next Steps for Testing

1. **Test the authentication flow:**
   ```bash
   make up
   ```
2. **Verify Firebase Integration:**
   - Test guest login ("Continue as Guest")
   - Test signup with new email
   - Test login with created account
   - Test profile editing and persistence
   - Check Firebase Console → Authentication for user entries
   - Check Firebase Console → Firestore for user profile documents
3. **Optional: Create demo account** in Firebase Console:
   - Email: `reviewer@burpeebata.com`
   - Password: `Reviewer2025!`

### Ready for Production

Once testing is complete, the app is ready for:
- Google Play Store submission (with guest access for reviewers)
- Apple App Store submission (may need to update iOS bundle ID)
- Web deployment at burpeebata.com

Include contents of `APP_STORE_REVIEWER_ACCESS.md` in app store submission notes.
